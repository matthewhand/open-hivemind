name: PR Deduplication Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-duplicates:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check for similar PRs
        uses: actions/github-script@v7
        with:
          script: |
            const currentPR = context.payload.pull_request;
            
            // 1. Get all open PRs
            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Filter out the current PR
            const otherPRs = openPRs.filter(pr => pr.number !== currentPR.number);
            
            if (otherPRs.length === 0) {
              console.log('No other open PRs found.');
              return;
            }
            
            // 2. Simple title similarity check (very basic)
            const currentTitleWords = new Set(currentPR.title.toLowerCase().split(/\W+/).filter(w => w.length > 3));
            
            const potentialDuplicates = [];
            
            for (const pr of otherPRs) {
              const prTitleWords = new Set(pr.title.toLowerCase().split(/\W+/).filter(w => w.length > 3));
              
              // Calculate intersection
              const intersection = new Set([...currentTitleWords].filter(x => prTitleWords.has(x)));
              
              // If more than 3 significant words match, or > 50% match, flag it
              if (currentTitleWords.size > 0 && 
                 (intersection.size >= 3 || intersection.size / currentTitleWords.size > 0.5)) {
                potentialDuplicates.push(pr);
              }
            }
            
            // 3. If potential duplicates found, add a label and comment
            if (potentialDuplicates.length > 0) {
              console.log(`Found ${potentialDuplicates.length} potential duplicate PRs.`);
              
              // Add label
              try {
                // Ensure label exists (if it doesn't, this might fail, ideally pre-create it)
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: currentPR.number,
                  labels: ['potential-duplicate']
                });
              } catch (e) {
                console.log('Failed to add label, might not exist yet.');
              }
              
              // Add comment linking to potential duplicates
              const dupList = potentialDuplicates.map(pr => `- #${pr.number}: ${pr.title}`).join('\n');
              const commentBody = `ðŸ‘‹ Hello! Automated check here. \n\nThis PR seems very similar to the following open PR(s):\n${dupList}\n\nPlease verify if this is a duplicate. If it is, consider closing this one and collaborating on the existing PR. If not, feel free to ignore this message!`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentPR.number,
                body: commentBody
              });
            } else {
              console.log('No similar PRs detected based on title.');
            }
